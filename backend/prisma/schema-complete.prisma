// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(USER)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  sessions     Session[]
  tenantUsers  TenantUser[]
  deployments  Deployment[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  permissions String[] @default([])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

// ============================================
// TENANTS & BILLING
// ============================================

model Tenant {
  id        String        @id @default(cuid())
  name      String
  plan      TenantPlan    @default(FREE)
  status    TenantStatus  @default(ACTIVE)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  // Relations
  tenantUsers    TenantUser[]
  subscriptions  Subscription[]
  usageMetrics   UsageMetric[]
  notifications  Notification[]
  deployments    Deployment[]

  @@map("tenants")
}

model TenantUser {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  role      TenantRole @default(MEMBER)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@map("tenant_users")
}

model Subscription {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  plan        TenantPlan
  renewalDate DateTime     @map("renewal_date")
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model UsageMetric {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  metric    String
  value     Float
  timestamp DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, metric, timestamp])
  @@map("usage_metrics")
}

// ============================================
// MONITORING
// ============================================

model SystemMetric {
  id        String   @id @default(cuid())
  service   String
  cpu       Float
  ram       Float
  latency   Float?
  timestamp DateTime @default(now())

  @@index([service, timestamp])
  @@map("system_metrics")
}

model Log {
  id        String     @id @default(cuid())
  service   String
  level     LogLevel
  message   String
  metadata  Json?
  timestamp DateTime   @default(now())

  @@index([service, level, timestamp])
  @@map("logs")
}

model Alert {
  id        String     @id @default(cuid())
  type      AlertType
  severity  AlertSeverity
  message   String
  resolved  Boolean    @default(false)
  metadata  Json?
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@index([type, severity, createdAt])
  @@map("alerts")
}

// ============================================
// WEB3
// ============================================

model ContractEvent {
  id         String   @id @default(cuid())
  chain      String
  contract   String
  eventName  String   @map("event_name")
  payload    Json
  txHash     String   @map("tx_hash")
  blockNumber BigInt   @map("block_number")
  timestamp  DateTime @default(now())

  @@index([chain, contract, eventName])
  @@index([timestamp])
  @@map("contract_events")
}

model WalletActivity {
  id        String   @id @default(cuid())
  wallet    String
  chain     String
  action    String
  amount    String?
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([wallet, chain])
  @@index([timestamp])
  @@map("wallet_activity")
}

model FraudScore {
  id        String   @id @default(cuid())
  wallet    String
  score     Float
  reason    String
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([wallet, score])
  @@index([timestamp])
  @@map("fraud_scores")
}

// ============================================
// AI AGENTS
// ============================================

model AgentTask {
  id         String      @id @default(cuid())
  agentName  String      @map("agent_name")
  input      Json
  output     Json?
  status     TaskStatus  @default(PENDING)
  tokensUsed Int?        @map("tokens_used")
  error      String?
  startedAt  DateTime?   @map("started_at")
  completedAt DateTime?  @map("completed_at")
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([agentName, status])
  @@index([createdAt])
  @@map("agent_tasks")
}

model AgentFailure {
  id        String   @id @default(cuid())
  agentName String   @map("agent_name")
  error     String
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([agentName, timestamp])
  @@map("agent_failures")
}

// ============================================
// DEVOPS
// ============================================

model Deployment {
  id          String           @id @default(cuid())
  service     String
  version     String
  status      DeploymentStatus @default(PENDING)
  triggeredBy String           @map("triggered_by")
  metadata    Json?
  createdAt   DateTime         @default(now()) @map("created_at")
  completedAt DateTime?        @map("completed_at")

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User    @relation(fields: [userId], references: [id])

  @@index([service, status])
  @@index([createdAt])
  @@map("deployments")
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("feature_flags")
}

model Secret {
  id             String   @id @default(cuid())
  key            String   @unique
  encryptedValue String   @map("encrypted_value")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("secrets")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  tenantId  String           @map("tenant_id")
  type      NotificationType
  channel   NotificationChannel
  payload   Json
  sent      Boolean          @default(false)
  sentAt    DateTime?        @map("sent_at")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type, sent])
  @@map("notifications")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum AlertType {
  SYSTEM
  SECURITY
  PERFORMANCE
  BUSINESS
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum DeploymentStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  ROLLED_BACK
}

enum NotificationType {
  SYSTEM_ALERT
  BILLING
  SECURITY
  DEPLOYMENT
  USAGE_LIMIT
}

enum NotificationChannel {
  EMAIL
  SMS
  SLACK
  WEBHOOK
}
