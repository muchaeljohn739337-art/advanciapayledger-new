// SPRINT 1 COMPREHENSIVE SCHEMA
// This schema includes all tables for the complete system architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTH
// ============================================

model Sprint1User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  userRole     UserRole  @default(USER) @map("role")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  sessions     Sprint1Session[]
  tenantUsers  Sprint1TenantUser[]
  deployments  Sprint1Deployment[]

  @@map("sprint1_users")
}

model Sprint1Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user Sprint1User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sprint1_sessions")
}

model UserRole {
  id          String   @id @default(cuid())
  name        String   @unique
  permissions String[] @default([])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("user_roles")
}

// ============================================
// TENANTS & BILLING
// ============================================

model Sprint1Tenant {
  id        String         @id @default(cuid())
  name      String
  plan      TenantPlan     @default(FREE)
  status    TenantStatus   @default(ACTIVE)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  // Relations
  tenantUsers    Sprint1TenantUser[]
  subscriptions  Sprint1Subscription[]
  usageMetrics   Sprint1UsageMetric[]
  notifications  Sprint1Notification[]
  deployments    Sprint1Deployment[]

  @@map("sprint1_tenants")
}

model Sprint1TenantUser {
  id        String     @id @default(cuid())
  tenantId  String     @map("tenant_id")
  userId    String     @map("user_id")
  role      TenantRole @default(MEMBER)
  createdAt DateTime   @default(now()) @map("created_at")

  // Relations
  tenant Sprint1Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   Sprint1User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@map("sprint1_tenant_users")
}

model Sprint1Subscription {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  plan        TenantPlan
  renewalDate DateTime      @map("renewal_date")
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant Sprint1Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sprint1_subscriptions")
}

model Sprint1UsageMetric {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  metric    String
  value     Float
  timestamp DateTime @default(now())

  // Relations
  tenant Sprint1Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, metric, timestamp])
  @@map("sprint1_usage_metrics")
}

// ============================================
// MONITORING
// ============================================

model Sprint1SystemMetric {
  id        String   @id @default(cuid())
  service   String
  cpu       Float
  ram       Float
  latency   Float?
  timestamp DateTime @default(now())

  @@index([service, timestamp])
  @@map("sprint1_system_metrics")
}

model Sprint1Log {
  id        String     @id @default(cuid())
  service   String
  level     LogLevel
  message   String
  metadata  Json?
  timestamp DateTime   @default(now())

  @@index([service, level, timestamp])
  @@map("sprint1_logs")
}

model Sprint1Alert {
  id        String        @id @default(cuid())
  type      AlertType
  severity  AlertSeverity
  message   String
  resolved  Boolean       @default(false)
  metadata  Json?
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@index([type, severity, createdAt])
  @@map("sprint1_alerts")
}

// ============================================
// WEB3
// ============================================

model Sprint1ContractEvent {
  id         String   @id @default(cuid())
  chain      String
  contract   String
  eventName  String   @map("event_name")
  payload    Json
  txHash     String   @map("tx_hash")
  blockNumber BigInt   @map("block_number")
  timestamp  DateTime @default(now())

  @@index([chain, contract, eventName])
  @@index([timestamp])
  @@map("sprint1_contract_events")
}

model Sprint1WalletActivity {
  id        String   @id @default(cuid())
  wallet    String
  chain     String
  action    String
  amount    String?
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([wallet, chain])
  @@index([timestamp])
  @@map("sprint1_wallet_activity")
}

model Sprint1FraudScore {
  id        String   @id @default(cuid())
  wallet    String
  score     Float
  reason    String
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([wallet, score])
  @@index([timestamp])
  @@map("sprint1_fraud_scores")
}

// ============================================
// AI AGENTS
// ============================================

model Sprint1AgentTask {
  id         String      @id @default(cuid())
  agentName  String      @map("agent_name")
  input      Json
  output     Json?
  status     TaskStatus  @default(PENDING)
  tokensUsed Int?        @map("tokens_used")
  error      String?
  startedAt  DateTime?   @map("started_at")
  completedAt DateTime?  @map("completed_at")
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([agentName, status])
  @@index([createdAt])
  @@map("sprint1_agent_tasks")
}

model Sprint1AgentFailure {
  id        String   @id @default(cuid())
  agentName String   @map("agent_name")
  error     String
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([agentName, timestamp])
  @@map("sprint1_agent_failures")
}

// ============================================
// DEVOPS
// ============================================

model Sprint1Deployment {
  id          String           @id @default(cuid())
  service     String
  version     String
  status      DeploymentStatus @default(PENDING)
  triggeredBy String           @map("triggered_by")
  tenantId    String?          @map("tenant_id")
  userId      String?          @map("user_id")
  metadata    Json?
  createdAt   DateTime         @default(now()) @map("created_at")
  completedAt DateTime?        @map("completed_at")

  // Relations
  tenant Sprint1Tenant? @relation(fields: [tenantId], references: [id])
  user   Sprint1User?   @relation(fields: [userId], references: [id])

  @@index([service, status])
  @@index([createdAt])
  @@map("sprint1_deployments")
}

model Sprint1FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("sprint1_feature_flags")
}

model Sprint1Secret {
  id             String   @id @default(cuid())
  key            String   @unique
  encryptedValue String   @map("encrypted_value")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("sprint1_secrets")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Sprint1Notification {
  id        String               @id @default(cuid())
  tenantId  String               @map("tenant_id")
  type      Sprint1NotificationType
  channel   NotificationChannel
  payload   Json
  sent      Boolean              @default(false)
  sentAt    DateTime?            @map("sent_at")
  createdAt DateTime             @default(now()) @map("created_at")

  // Relations
  tenant Sprint1Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type, sent])
  @@map("sprint1_notifications")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum AlertType {
  SYSTEM
  SECURITY
  PERFORMANCE
  BUSINESS
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum DeploymentStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  ROLLED_BACK
}

enum Sprint1NotificationType {
  SYSTEM_ALERT
  BILLING
  SECURITY
  DEPLOYMENT
  USAGE_LIMIT
}

enum NotificationChannel {
  EMAIL
  SMS
  SLACK
  WEBHOOK
}
