generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- User Management & Authentication ---
model User {
  id                String    @id @default(uuid())
  supabaseId        String?   @unique  // For Supabase Auth integration
  email             String    @unique
  passwordHash      String?
  firstName         String?
  lastName          String?
  phoneNumber       String?
  role              UserRole  @default(PATIENT)
  status            UserStatus @default(ACTIVE)
  isActive          Boolean   @default(true)  // Compatibility field
  emailVerified     Boolean   @default(false)
  totpSecret        String?   // 2FA/TOTP
  totpEnabled       Boolean   @default(false)
  twoFactorEnabled  Boolean   @default(false) // Alias for totpEnabled
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  facility          Facility? @relation(fields: [facilityId], references: [id])
  facilityId        String?
  sessions          Session[]
  notifications     Notification[]
  oauthProviders    OAuthProvider[]
  wallets           Wallet[]
  virtualCards      VirtualCard[]
  
  @@index([email])
  @@index([facilityId])
  @@index([supabaseId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  FACILITY_ADMIN
  FACILITY_STAFF
  BILLING_MANAGER
  PATIENT
  SUPPORT_AGENT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
  PENDING_VERIFICATION
}

model Session {
  id            String   @id @default(uuid())
  userId        String
  token         String   @unique
  refreshToken  String?  @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model OAuthProvider {
  id            String   @id @default(uuid())
  userId        String
  provider      String   // 'google', 'microsoft', etc.
  providerId    String   // Provider's user ID
  accessToken   String   @db.Text
  refreshToken  String?  @db.Text
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_providers")
}

// --- Healthcare Facilities ---
model Facility {
  id                    String            @id @default(uuid())
  name                  String
  legalName             String
  facilityType          FacilityType
  npi                   String?           @unique // National Provider Identifier
  taxId                 String?
  licenseNumber         String?
  
  // Contact Info
  email                 String
  phoneNumber           String
  website               String?
  
  // Address
  addressLine1          String
  addressLine2          String?
  city                  String
  state                 String
  zipCode               String
  country               String            @default("US")
  
  // Business Details
  status                FacilityStatus    @default(ACTIVE)
  subscriptionTier      SubscriptionTier  @default(STARTER)
  onboardedAt           DateTime?
  contractStartDate     DateTime?
  contractEndDate       DateTime?
  
  // Compliance
  hipaaCompliant        Boolean           @default(false)
  pciCompliant          Boolean           @default(false)
  lastComplianceCheck   DateTime?
  
  // Billing
  stripeCustomerId      String?           @unique
  stripeSubscriptionId  String?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  users                 User[]
  patients              Patient[]
  transactions          Transaction[]
  invoices              Invoice[]
  paymentMethods        PaymentMethod[]
  ehrIntegration        EHRIntegration?
  analytics             FacilityAnalytics[]
  payments              Payment[]
  providers             Provider[]
  
  @@index([status])
  @@index([subscriptionTier])
  @@map("facilities")
}

enum FacilityType {
  HOSPITAL
  CLINIC
  URGENT_CARE
  SPECIALTY_CLINIC
  DENTAL
  PHYSICAL_THERAPY
  MENTAL_HEALTH
  DIAGNOSTIC_CENTER
  PHARMACY
  OTHER
}

enum FacilityStatus {
  ACTIVE
  ONBOARDING
  SUSPENDED
  TERMINATED
  TRIAL
}

enum SubscriptionTier {
  TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

// --- Patient Management ---
model Patient {
  id                String        @id @default(uuid())
  facilityId        String
  
  // Personal Info
  firstName         String
  lastName          String
  middleName        String?
  dateOfBirth       DateTime
  gender            Gender
  email             String?
  phoneNumber       String?
  
  // Medical Record
  mrn               String        // Medical Record Number (facility-specific)
  ssn               String?       @db.Text // Encrypted
  
  // Address
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  zipCode           String?
  
  // Emergency Contact
  emergencyContactName   String?
  emergencyContactPhone  String?
  emergencyContactRelation String?
  
  // Insurance
  insuranceProvider      String?
  insurancePolicyNumber  String?
  insuranceGroupNumber   String?
  
  status            PatientStatus @default(ACTIVE)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  facility          Facility      @relation(fields: [facilityId], references: [id])
  transactions      Transaction[]
  invoices          Invoice[]
  paymentMethods    PaymentMethod[]
  appointments      Appointment[]
  payments          Payment[]
  
  @@unique([facilityId, mrn])
  @@index([facilityId])
  @@index([email])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
  OTHER
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  DECEASED
}

// --- Appointments ---
model Appointment {
  id                String              @id @default(uuid())
  patientId         String
  facilityId        String
  providerId        String?
  
  appointmentDate   DateTime
  duration          Int                 // minutes
  appointmentType   String
  status            AppointmentStatus   @default(SCHEDULED)
  
  // Cost
  estimatedCost     Decimal?            @db.Decimal(10, 2)
  actualCost        Decimal?            @db.Decimal(10, 2)
  
  notes             String?             @db.Text
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  patient           Patient             @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([facilityId])
  @@index([appointmentDate])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// --- Transactions & Payments ---
model Transaction {
  id                    String              @id @default(uuid())
  facilityId            String
  patientId             String?
  invoiceId             String?
  virtualCardId         String?
  walletId              String?
  
  // Transaction Details
  type                  TransactionType
  status                TransactionStatus
  amount                Decimal             @db.Decimal(10, 2)
  currency              String              @default("USD")
  
  // Payment Method
  paymentMethodType     PaymentMethodType
  paymentMethodId       String?
  
  // Stripe (Traditional)
  stripePaymentIntentId String?             @unique
  stripeChargeId        String?
  
  // Crypto
  blockchainNetwork     BlockchainNetwork?
  walletAddress         String?
  transactionHash       String?             @unique
  cryptoAmount          Decimal?            @db.Decimal(20, 8)
  cryptoCurrency        String?
  
  // Fees & Settlement
  processingFee         Decimal?            @db.Decimal(10, 2)
  platformFee           Decimal?            @db.Decimal(10, 2)
  netAmount             Decimal?            @db.Decimal(10, 2)
  
  // Metadata
  description           String?
  metadata              Json?
  
  // Fraud Detection
  fraudScore            Float?
  fraudStatus           FraudStatus         @default(PENDING)
  fraudCheckedAt        DateTime?
  
  // Timeline
  processedAt           DateTime?
  settledAt             DateTime?
  refundedAt            DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  facility              Facility            @relation(fields: [facilityId], references: [id])
  patient               Patient?            @relation(fields: [patientId], references: [id])
  invoice               Invoice?            @relation(fields: [invoiceId], references: [id])
  virtualCard           VirtualCard?        @relation(fields: [virtualCardId], references: [id])
  wallet                Wallet?             @relation(fields: [walletId], references: [id])
  refunds               Refund[]
  
  @@index([facilityId])
  @@index([patientId])
  @@index([invoiceId])
  @@index([virtualCardId])
  @@index([walletId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionType {
  PAYMENT
  REFUND
  PAYOUT
  ADJUSTMENT
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  ACH
  CRYPTO
  CASH
  CHECK
  INSURANCE
}

enum BlockchainNetwork {
  SOLANA
  ETHEREUM
  POLYGON
  BASE
  BINANCE_SMART_CHAIN
}

enum FraudStatus {
  PENDING
  APPROVED
  FLAGGED
  BLOCKED
  REVIEW_REQUIRED
}

model PaymentMethod {
  id                String              @id @default(uuid())
  facilityId        String?
  patientId         String?
  
  type              PaymentMethodType
  isDefault         Boolean             @default(false)
  status            PaymentMethodStatus @default(ACTIVE)
  
  // Card Details (encrypted/tokenized)
  cardLast4         String?
  cardBrand         String?
  cardExpMonth      Int?
  cardExpYear       Int?
  
  // Bank Account
  bankName          String?
  bankAccountLast4  String?
  bankAccountType   String?             // 'checking' or 'savings'
  
  // Crypto Wallet
  walletAddress     String?
  walletType        String?
  blockchainNetwork BlockchainNetwork?
  
  // Stripe
  stripePaymentMethodId String?         @unique
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  facility          Facility?           @relation(fields: [facilityId], references: [id])
  patient           Patient?            @relation(fields: [patientId], references: [id])
  
  @@index([facilityId])
  @@index([patientId])
  @@map("payment_methods")
}

enum PaymentMethodStatus {
  ACTIVE
  EXPIRED
  DISABLED
  PENDING_VERIFICATION
}

model Refund {
  id                String          @id @default(uuid())
  transactionId     String
  paymentId         String?         // Alias for transactionId - backwards compatibility
  
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("USD")
  reason            String?
  status            RefundStatus    @default(PENDING)
  
  stripeRefundId    String?         @unique
  
  processedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  transaction       Transaction     @relation(fields: [transactionId], references: [id])
  
  @@index([transactionId])
  @@index([paymentId])
  @@map("refunds")
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// --- Invoicing & Billing ---
model Invoice {
  id                String          @id @default(uuid())
  invoiceNumber     String          @unique
  facilityId        String
  patientId         String
  
  // Amounts
  subtotal          Decimal         @db.Decimal(10, 2)
  taxAmount         Decimal?        @db.Decimal(10, 2)
  discountAmount    Decimal?        @db.Decimal(10, 2)
  totalAmount       Decimal         @db.Decimal(10, 2)
  paidAmount        Decimal         @default(0) @db.Decimal(10, 2)
  balanceDue        Decimal         @db.Decimal(10, 2)
  
  // Status & Dates
  status            InvoiceStatus   @default(DRAFT)
  dueDate           DateTime?
  issuedDate        DateTime?
  paidDate          DateTime?
  
  // Metadata
  notes             String?         @db.Text
  metadata          Json?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  facility          Facility        @relation(fields: [facilityId], references: [id])
  patient           Patient         @relation(fields: [patientId], references: [id])
  lineItems         InvoiceLineItem[]
  transactions      Transaction[]
  
  @@index([facilityId])
  @@index([patientId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model InvoiceLineItem {
  id              String    @id @default(uuid())
  invoiceId       String
  
  description     String
  quantity        Int       @default(1)
  unitPrice       Decimal   @db.Decimal(10, 2)
  totalPrice      Decimal   @db.Decimal(10, 2)
  
  // Medical Coding
  cptCode         String?   // Current Procedural Terminology
  icdCode         String?   // International Classification of Diseases
  
  metadata        Json?
  createdAt       DateTime  @default(now())
  
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@map("invoice_line_items")
}

// --- EHR Integration ---
model EHRIntegration {
  id                String          @id @default(uuid())
  facilityId        String          @unique
  
  ehrSystem         EHRSystem
  apiEndpoint       String
  apiKey            String          @db.Text // Encrypted
  isActive          Boolean         @default(true)
  
  // Sync Settings
  lastSyncAt        DateTime?
  syncFrequency     Int?            // minutes
  autoSync          Boolean         @default(false)
  
  // Mapping Config
  fieldMappings     Json?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  facility          Facility        @relation(fields: [facilityId], references: [id])
  syncLogs          EHRSyncLog[]
  
  @@map("ehr_integrations")
}

enum EHRSystem {
  EPIC
  CERNER
  ALLSCRIPTS
  ATHENAHEALTH
  ECLINICALWORKS
  MEDITECH
  NEXTGEN
  CUSTOM
}

model EHRSyncLog {
  id                String          @id @default(uuid())
  ehrIntegrationId  String
  
  syncType          String          // 'patients', 'appointments', 'billing'
  status            String          // 'success', 'failed', 'partial'
  recordsProcessed  Int             @default(0)
  recordsFailed     Int             @default(0)
  errorMessage      String?         @db.Text
  
  startedAt         DateTime
  completedAt       DateTime?
  
  ehrIntegration    EHRIntegration  @relation(fields: [ehrIntegrationId], references: [id])
  
  @@index([ehrIntegrationId])
  @@index([startedAt])
  @@map("ehr_sync_logs")
}

// --- Analytics & Reporting ---
model FacilityAnalytics {
  id                    String    @id @default(uuid())
  facilityId            String
  date                  DateTime  // Daily aggregation
  
  // Revenue Metrics
  totalRevenue          Decimal   @db.Decimal(10, 2)
  cryptoRevenue         Decimal   @db.Decimal(10, 2)
  traditionalRevenue    Decimal   @db.Decimal(10, 2)
  
  // Transaction Metrics
  totalTransactions     Int
  successfulTransactions Int
  failedTransactions    Int
  refundedTransactions  Int
  
  // Patient Metrics
  totalPatients         Int
  newPatients           Int
  activePatients        Int
  
  // Appointment Metrics
  totalAppointments     Int
  completedAppointments Int
  cancelledAppointments Int
  noShows               Int
  
  // Financial Metrics
  averageTransactionValue Decimal @db.Decimal(10, 2)
  processingFees        Decimal   @db.Decimal(10, 2)
  netRevenue            Decimal   @db.Decimal(10, 2)
  
  createdAt             DateTime  @default(now())
  
  facility              Facility  @relation(fields: [facilityId], references: [id])
  
  @@unique([facilityId, date])
  @@index([facilityId])
  @@index([date])
  @@map("facility_analytics")
}

// --- Audit & Compliance ---
model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  
  action        String    // 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', etc.
  entityType    String?   // 'Patient', 'Transaction', etc.
  resource      String?   // Alias for entityType - backwards compatibility
  entityId      String?
  resourceId    String?   // Alias for entityId - backwards compatibility
  
  // HIPAA Tracking
  ipAddress     String?
  userAgent     String?
  metadata      Json?
  details       Json?     // Alias for metadata - backwards compatibility
  
  timestamp     DateTime  @default(now())
  createdAt     DateTime  @default(now()) // Alias for timestamp
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

model Notification {
  id            String              @id @default(uuid())
  userId        String
  
  type          NotificationType
  title         String
  message       String              @db.Text
  priority      NotificationPriority @default(NORMAL)
  
  isRead        Boolean             @default(false)
  readAt        DateTime?
  
  // Action
  actionUrl     String?
  metadata      Json?
  
  createdAt     DateTime            @default(now())
  
  user          User                @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// --- Virtual Cards ---
model VirtualCard {
  id                String              @id @default(uuid())
  userId            String
  walletId          String
  
  // Security: Sensitive data is ALWAYS hashed/encrypted
  cardNumberHash    String              // Hashed card number
  cvvHash           String              // Hashed CVV
  expiryDate        DateTime
  
  // Display fields (safe to expose)
  cardLast4         String?             // Last 4 digits for display
  cardBrand         String?             // VISA, Mastercard, etc.
  
  // Limits & Status
  status            VirtualCardStatus   @default(ACTIVE)
  dailyLimit        Decimal             @default(1000) @db.Decimal(10, 2)
  monthlyLimit      Decimal             @default(5000) @db.Decimal(10, 2)
  currency          String              @default("USD")
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  user              User                @relation(fields: [userId], references: [id])
  wallet            Wallet              @relation(fields: [walletId], references: [id])
  transactions      Transaction[]
  
  @@index([userId])
  @@index([walletId])
  @@index([status])
  @@map("virtual_cards")
}

enum VirtualCardStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

// --- Wallets ---
model Wallet {
  id                String            @id @default(uuid())
  userId            String
  
  // Balance
  balance           Decimal           @default(0) @db.Decimal(20, 8)
  currency          String            @default("USD")
  
  // Crypto Support
  solanaAddress     String?           @unique
  ethereumAddress  String?           @unique
  
  status            WalletStatus      @default(ACTIVE)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  user              User              @relation(fields: [userId], references: [id])
  virtualCards      VirtualCard[]
  transactions      Transaction[]
  
  @@index([userId])
  @@index([status])
  @@map("wallets")
}

enum WalletStatus {
  ACTIVE
  SUSPENDED
  FROZEN
  CLOSED
}

enum NotificationType {
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  REFUND_PROCESSED
  INVOICE_CREATED
  INVOICE_OVERDUE
  APPOINTMENT_REMINDER
  COMPLIANCE_ALERT
  SYSTEM_ALERT
  SECURITY_ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// --- Payment Model (alias for Transaction for backward compatibility) ---
model Payment {
  id                String            @id @default(uuid())
  facilityId        String
  patientId         String?
  providerId        String?
  invoiceId         String?
  
  amount            Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  paymentMethod     PaymentMethodType
  status            TransactionStatus @default(PENDING)
  
  // Stripe Integration
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?
  
  // Crypto
  blockchainNetwork     BlockchainNetwork?
  walletAddress         String?
  transactionHash       String?       
  cryptoAmount          Decimal?      @db.Decimal(20, 8)
  cryptoCurrency        String?
  transactionId         String?
  
  // Fees & Settlement
  processingFee         Decimal?      @db.Decimal(10, 2)
  platformFee           Decimal?      @db.Decimal(10, 2)
  netAmount             Decimal?      @db.Decimal(10, 2)
  
  description           String?
  metadata              Json?
  createdBy             String?
  
  processedAt           DateTime?
  settledAt             DateTime?
  refundedAt            DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  // Relations
  facility              Facility      @relation(fields: [facilityId], references: [id])
  patient               Patient?      @relation(fields: [patientId], references: [id])
  
  @@index([facilityId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// --- Crypto Payments ---
model CryptoPayment {
  id                String            @id @default(uuid())
  paymentId         String?
  userId            String
  
  amount            Decimal           @db.Decimal(20, 8)
  currency          String
  cryptoCurrency    String
  walletAddress     String
  network           BlockchainNetwork
  transactionHash   String?           @unique
  
  status            TransactionStatus @default(PENDING)
  confirmations     Int               @default(0)
  
  exchangeRate      Decimal?          @db.Decimal(20, 8)
  feeAmount         Decimal?          @db.Decimal(20, 8)
  
  expiresAt         DateTime?
  confirmedAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([userId])
  @@index([status])
  @@map("crypto_payments")
}

// --- Multi-tenant Support ---
model Tenant {
  id                String            @id @default(uuid())
  name              String
  subdomain         String            @unique
  domain            String?           @unique
  status            String            @default("active")
  plan              String            @default("free")
  settings          Json?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  tenantUsers       TenantUser[]
  
  @@map("tenants")
}

model TenantUser {
  id                String            @id @default(uuid())
  tenantId          String
  userId            String
  role              String            @default("member")
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_users")
}

// --- Provider Model ---
model Provider {
  id                String            @id @default(uuid())
  facilityId        String
  userId            String?
  
  firstName         String
  lastName          String
  email             String?
  phone             String?
  npi               String?           @unique
  specialty         String?
  
  isActive          Boolean           @default(true)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  facility          Facility          @relation(fields: [facilityId], references: [id])
  
  @@index([facilityId])
  @@map("providers")
}

// --- Alert Model ---
model Alert {
  id                String            @id @default(uuid())
  userId            String
  type              String
  severity          String
  title             String
  message           String
  transactionId     String?
  amount            Decimal?          @db.Decimal(10, 2)
  currency          String?
  paymentMethod     String?
  riskScore         Float?
  isRead            Boolean           @default(false)
  metadata          Json?
  
  createdAt         DateTime          @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("alerts")
}
