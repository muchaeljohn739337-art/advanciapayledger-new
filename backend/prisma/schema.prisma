generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- User Management & Authentication ---
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  firstName         String
  lastName          String
  phoneNumber       String?
  role              UserRole
  status            UserStatus @default(ACTIVE)
  emailVerified     Boolean   @default(false)
  totpSecret        String?   // 2FA/TOTP
  totpEnabled       Boolean   @default(false)
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  facility          Facility? @relation(fields: [facilityId], references: [id])
  facilityId        String?
  sessions          Session[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  oauthProviders    OAuthProvider[]
  
  @@index([email])
  @@index([facilityId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  FACILITY_ADMIN
  FACILITY_STAFF
  BILLING_MANAGER
  PATIENT
  SUPPORT_AGENT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
  PENDING_VERIFICATION
}

model Session {
  id            String   @id @default(uuid())
  userId        String
  token         String   @unique
  refreshToken  String?  @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model OAuthProvider {
  id            String   @id @default(uuid())
  userId        String
  provider      String   // 'google', 'microsoft', etc.
  providerId    String   // Provider's user ID
  accessToken   String   @db.Text
  refreshToken  String?  @db.Text
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_providers")
}

// --- Healthcare Facilities ---
model Facility {
  id                    String            @id @default(uuid())
  name                  String
  legalName             String
  facilityType          FacilityType
  npi                   String?           @unique // National Provider Identifier
  taxId                 String?
  licenseNumber         String?
  
  // Contact Info
  email                 String
  phoneNumber           String
  website               String?
  
  // Address
  addressLine1          String
  addressLine2          String?
  city                  String
  state                 String
  zipCode               String
  country               String            @default("US")
  
  // Business Details
  status                FacilityStatus    @default(ACTIVE)
  subscriptionTier      SubscriptionTier  @default(STARTER)
  onboardedAt           DateTime?
  contractStartDate     DateTime?
  contractEndDate       DateTime?
  
  // Compliance
  hipaaCompliant        Boolean           @default(false)
  pciCompliant          Boolean           @default(false)
  lastComplianceCheck   DateTime?
  
  // Billing
  stripeCustomerId      String?           @unique
  stripeSubscriptionId  String?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  users                 User[]
  patients              Patient[]
  transactions          Transaction[]
  invoices              Invoice[]
  paymentMethods        PaymentMethod[]
  ehrIntegration        EHRIntegration?
  analytics             FacilityAnalytics[]
  
  @@index([status])
  @@index([subscriptionTier])
  @@map("facilities")
}

enum FacilityType {
  HOSPITAL
  CLINIC
  URGENT_CARE
  SPECIALTY_CLINIC
  DENTAL
  PHYSICAL_THERAPY
  MENTAL_HEALTH
  DIAGNOSTIC_CENTER
  PHARMACY
  OTHER
}

enum FacilityStatus {
  ACTIVE
  ONBOARDING
  SUSPENDED
  TERMINATED
  TRIAL
}

enum SubscriptionTier {
  TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

// --- Patient Management ---
model Patient {
  id                String        @id @default(uuid())
  facilityId        String
  
  // Personal Info
  firstName         String
  lastName          String
  middleName        String?
  dateOfBirth       DateTime
  gender            Gender
  email             String?
  phoneNumber       String?
  
  // Medical Record
  mrn               String        // Medical Record Number (facility-specific)
  ssn               String?       @db.Text // Encrypted
  
  // Address
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  zipCode           String?
  
  // Emergency Contact
  emergencyContactName   String?
  emergencyContactPhone  String?
  emergencyContactRelation String?
  
  // Insurance
  insuranceProvider      String?
  insurancePolicyNumber  String?
  insuranceGroupNumber   String?
  
  status            PatientStatus @default(ACTIVE)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  facility          Facility      @relation(fields: [facilityId], references: [id])
  transactions      Transaction[]
  invoices          Invoice[]
  paymentMethods    PaymentMethod[]
  appointments      Appointment[]
  
  @@unique([facilityId, mrn])
  @@index([facilityId])
  @@index([email])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
  OTHER
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  DECEASED
}

// --- Appointments ---
model Appointment {
  id                String              @id @default(uuid())
  patientId         String
  facilityId        String
  providerId        String?
  
  appointmentDate   DateTime
  duration          Int                 // minutes
  appointmentType   String
  status            AppointmentStatus   @default(SCHEDULED)
  
  // Cost
  estimatedCost     Decimal?            @db.Decimal(10, 2)
  actualCost        Decimal?            @db.Decimal(10, 2)
  
  notes             String?             @db.Text
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  patient           Patient             @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([facilityId])
  @@index([appointmentDate])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// --- Transactions & Payments ---
model Transaction {
  id                    String              @id @default(uuid())
  facilityId            String
  patientId             String?
  invoiceId             String?
  
  // Transaction Details
  type                  TransactionType
  status                TransactionStatus
  amount                Decimal             @db.Decimal(10, 2)
  currency              String              @default("USD")
  
  // Payment Method
  paymentMethodType     PaymentMethodType
  paymentMethodId       String?
  
  // Stripe (Traditional)
  stripePaymentIntentId String?             @unique
  stripeChargeId        String?
  
  // Crypto
  blockchainNetwork     BlockchainNetwork?
  walletAddress         String?
  transactionHash       String?             @unique
  cryptoAmount          Decimal?            @db.Decimal(20, 8)
  cryptoCurrency        String?
  
  // Fees & Settlement
  processingFee         Decimal?            @db.Decimal(10, 2)
  platformFee           Decimal?            @db.Decimal(10, 2)
  netAmount             Decimal?            @db.Decimal(10, 2)
  
  // Metadata
  description           String?
  metadata              Json?
  
  // Fraud Detection
  fraudScore            Float?
  fraudStatus           FraudStatus         @default(PENDING)
  fraudCheckedAt        DateTime?
  
  // Timeline
  processedAt           DateTime?
  settledAt             DateTime?
  refundedAt            DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  facility              Facility            @relation(fields: [facilityId], references: [id])
  patient               Patient?            @relation(fields: [patientId], references: [id])
  invoice               Invoice?            @relation(fields: [invoiceId], references: [id])
  refunds               Refund[]
  
  @@index([facilityId])
  @@index([patientId])
  @@index([invoiceId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionType {
  PAYMENT
  REFUND
  PAYOUT
  ADJUSTMENT
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  ACH
  CRYPTO
  CASH
  CHECK
  INSURANCE
}

enum BlockchainNetwork {
  SOLANA
  ETHEREUM
  POLYGON
  BASE
  BINANCE_SMART_CHAIN
}

enum FraudStatus {
  PENDING
  APPROVED
  FLAGGED
  BLOCKED
  REVIEW_REQUIRED
}

model PaymentMethod {
  id                String              @id @default(uuid())
  facilityId        String?
  patientId         String?
  
  type              PaymentMethodType
  isDefault         Boolean             @default(false)
  status            PaymentMethodStatus @default(ACTIVE)
  
  // Card Details (encrypted/tokenized)
  cardLast4         String?
  cardBrand         String?
  cardExpMonth      Int?
  cardExpYear       Int?
  
  // Bank Account
  bankName          String?
  bankAccountLast4  String?
  bankAccountType   String?             // 'checking' or 'savings'
  
  // Crypto Wallet
  walletAddress     String?
  walletType        String?
  blockchainNetwork BlockchainNetwork?
  
  // Stripe
  stripePaymentMethodId String?         @unique
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  facility          Facility?           @relation(fields: [facilityId], references: [id])
  patient           Patient?            @relation(fields: [patientId], references: [id])
  
  @@index([facilityId])
  @@index([patientId])
  @@map("payment_methods")
}

enum PaymentMethodStatus {
  ACTIVE
  EXPIRED
  DISABLED
  PENDING_VERIFICATION
}

model Refund {
  id                String          @id @default(uuid())
  transactionId     String
  
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("USD")
  reason            String?
  status            RefundStatus    @default(PENDING)
  
  stripeRefundId    String?         @unique
  
  processedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  transaction       Transaction     @relation(fields: [transactionId], references: [id])
  
  @@index([transactionId])
  @@map("refunds")
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// --- Invoicing & Billing ---
model Invoice {
  id                String          @id @default(uuid())
  invoiceNumber     String          @unique
  facilityId        String
  patientId         String
  
  // Amounts
  subtotal          Decimal         @db.Decimal(10, 2)
  taxAmount         Decimal?        @db.Decimal(10, 2)
  discountAmount    Decimal?        @db.Decimal(10, 2)
  totalAmount       Decimal         @db.Decimal(10, 2)
  paidAmount        Decimal         @default(0) @db.Decimal(10, 2)
  balanceDue        Decimal         @db.Decimal(10, 2)
  
  // Status & Dates
  status            InvoiceStatus   @default(DRAFT)
  dueDate           DateTime?
  issuedDate        DateTime?
  paidDate          DateTime?
  
  // Metadata
  notes             String?         @db.Text
  metadata          Json?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  facility          Facility        @relation(fields: [facilityId], references: [id])
  patient           Patient         @relation(fields: [patientId], references: [id])
  lineItems         InvoiceLineItem[]
  transactions      Transaction[]
  
  @@index([facilityId])
  @@index([patientId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model InvoiceLineItem {
  id              String    @id @default(uuid())
  invoiceId       String
  
  description     String
  quantity        Int       @default(1)
  unitPrice       Decimal   @db.Decimal(10, 2)
  totalPrice      Decimal   @db.Decimal(10, 2)
  
  // Medical Coding
  cptCode         String?   // Current Procedural Terminology
  icdCode         String?   // International Classification of Diseases
  
  metadata        Json?
  createdAt       DateTime  @default(now())
  
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@map("invoice_line_items")
}

// --- EHR Integration ---
model EHRIntegration {
  id                String          @id @default(uuid())
  facilityId        String          @unique
  
  ehrSystem         EHRSystem
  apiEndpoint       String
  apiKey            String          @db.Text // Encrypted
  isActive          Boolean         @default(true)
  
  // Sync Settings
  lastSyncAt        DateTime?
  syncFrequency     Int?            // minutes
  autoSync          Boolean         @default(false)
  
  // Mapping Config
  fieldMappings     Json?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  facility          Facility        @relation(fields: [facilityId], references: [id])
  syncLogs          EHRSyncLog[]
  
  @@map("ehr_integrations")
}

enum EHRSystem {
  EPIC
  CERNER
  ALLSCRIPTS
  ATHENAHEALTH
  ECLINICALWORKS
  MEDITECH
  NEXTGEN
  CUSTOM
}

model EHRSyncLog {
  id                String          @id @default(uuid())
  ehrIntegrationId  String
  
  syncType          String          // 'patients', 'appointments', 'billing'
  status            String          // 'success', 'failed', 'partial'
  recordsProcessed  Int             @default(0)
  recordsFailed     Int             @default(0)
  errorMessage      String?         @db.Text
  
  startedAt         DateTime
  completedAt       DateTime?
  
  ehrIntegration    EHRIntegration  @relation(fields: [ehrIntegrationId], references: [id])
  
  @@index([ehrIntegrationId])
  @@index([startedAt])
  @@map("ehr_sync_logs")
}

// --- Analytics & Reporting ---
model FacilityAnalytics {
  id                    String    @id @default(uuid())
  facilityId            String
  date                  DateTime  // Daily aggregation
  
  // Revenue Metrics
  totalRevenue          Decimal   @db.Decimal(10, 2)
  cryptoRevenue         Decimal   @db.Decimal(10, 2)
  traditionalRevenue    Decimal   @db.Decimal(10, 2)
  
  // Transaction Metrics
  totalTransactions     Int
  successfulTransactions Int
  failedTransactions    Int
  refundedTransactions  Int
  
  // Patient Metrics
  totalPatients         Int
  newPatients           Int
  activePatients        Int
  
  // Appointment Metrics
  totalAppointments     Int
  completedAppointments Int
  cancelledAppointments Int
  noShows               Int
  
  // Financial Metrics
  averageTransactionValue Decimal @db.Decimal(10, 2)
  processingFees        Decimal   @db.Decimal(10, 2)
  netRevenue            Decimal   @db.Decimal(10, 2)
  
  createdAt             DateTime  @default(now())
  
  facility              Facility  @relation(fields: [facilityId], references: [id])
  
  @@unique([facilityId, date])
  @@index([facilityId])
  @@index([date])
  @@map("facility_analytics")
}

// --- Audit & Compliance ---
model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  
  action        String    // 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', etc.
  entityType    String    // 'Patient', 'Transaction', etc.
  entityId      String?
  
  // HIPAA Tracking
  ipAddress     String?
  userAgent     String?
  metadata      Json?
  
  timestamp     DateTime  @default(now())
  
  user          User?     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

model Notification {
  id            String              @id @default(uuid())
  userId        String
  
  type          NotificationType
  title         String
  message       String              @db.Text
  priority      NotificationPriority @default(NORMAL)
  
  isRead        Boolean             @default(false)
  readAt        DateTime?
  
  // Action
  actionUrl     String?
  metadata      Json?
  
  createdAt     DateTime            @default(now())
  
  user          User                @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  REFUND_PROCESSED
  INVOICE_CREATED
  INVOICE_OVERDUE
  APPOINTMENT_REMINDER
  COMPLIANCE_ALERT
  SYSTEM_ALERT
  SECURITY_ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
