name: PHI Integration Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - prod
  pull_request:
    paths:
      - "services/phi/**"
      - "tests/integration/**"

permissions:
  id-token: write
  contents: read
  checks: write

env:
  AWS_REGION: us-east-1

jobs:
  integration-tests:
    name: Run PHI Integration Tests
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: tests/integration/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TEST_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Test Credentials
        id: creds
        run: |
          SECRET=$(aws secretsmanager get-secret-value --secret-id advancia/${{ github.event.inputs.environment || 'staging' }}/test-credentials --query SecretString --output text)
          echo "API_BASE_URL=$(echo $SECRET | jq -r '.api_base_url')" >> $GITHUB_ENV
          echo "TEST_AUTH_TOKEN=$(echo $SECRET | jq -r '.auth_token')" >> $GITHUB_ENV
          echo "TEST_TENANT_ID=$(echo $SECRET | jq -r '.tenant_id')" >> $GITHUB_ENV

      - name: Install Dependencies
        working-directory: tests/integration
        run: npm ci

      - name: Run Integration Tests
        working-directory: tests/integration
        run: npm run test:ci
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
          TEST_AUTH_TOKEN: ${{ env.TEST_AUTH_TOKEN }}
          TEST_TENANT_ID: ${{ env.TEST_TENANT_ID }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/integration/test-results.xml
          retention-days: 30

      - name: Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: PHI Integration Test Results
          path: tests/integration/test-results.xml
          reporter: jest-junit

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: integration-tests
    if: success()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP Scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: ${{ secrets.API_BASE_URL }}
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a"
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: report_html.html
          retention-days: 30
