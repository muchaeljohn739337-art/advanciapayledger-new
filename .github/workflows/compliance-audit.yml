name: Compliance Audit (HIPAA + SOC 2)

on:
  workflow_dispatch:
    inputs:
      full_audit:
        description: "Run full audit including PHI redaction scan"
        required: false
        default: "true"
        type: boolean
  schedule:
    # Daily at 02:00 UTC for automated compliance monitoring
    - cron: "0 2 * * *"
    # Quarterly IAM review (first Monday of Jan, Apr, Jul, Oct)
    - cron: "0 8 1-7 1,4,7,10 1"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  infrastructure-audit:
    name: Infrastructure Compliance Audit
    runs-on: ubuntu-latest
    outputs:
      compliance_score: ${{ steps.audit.outputs.score }}
      has_failures: ${{ steps.audit.outputs.failed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_AUDIT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Run Compliance Audit
        id: audit
        run: |
          pwsh ./scripts/audit/audit-compliance.ps1 -Region ${{ env.AWS_REGION }} -Env prod -OutputFile audit-report.json

          # Extract metrics for output
          SCORE=$(jq -r '.summary.passed / .summary.total * 100 | floor' audit-report.json)
          FAILED=$(jq -r '.summary.failed' audit-report.json)

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-audit-report
          path: audit-report.json
          retention-days: 365

      - name: Post to Slack (Failures)
        if: steps.audit.outputs.failed > 0
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è Compliance Audit Alert",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Compliance Audit Failed*\n‚Ä¢ Score: ${{ steps.audit.outputs.score }}%\n‚Ä¢ Failures: ${{ steps.audit.outputs.failed }}\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}

  phi-redaction-audit:
    name: PHI Redaction Verification
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.full_audit == 'true' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_AUDIT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Scan Logs for PHI Leakage
        id: phi-scan
        run: |
          # Scan each PHI service log group
          SERVICES=("health-billing-service" "patient-link-service" "phi-docs-service" "claims-intake-service" "identity-service" "identity-worker")

          TOTAL_FINDINGS=0
          for SERVICE in "${SERVICES[@]}"; do
            echo "Scanning /aws/ecs/$SERVICE..."
            pwsh ./scripts/audit/verify-phi-redaction.ps1 -LogGroup "/aws/ecs/$SERVICE" -Hours 24 -Region ${{ env.AWS_REGION }} || TOTAL_FINDINGS=$((TOTAL_FINDINGS + 1))
          done

          echo "findings=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Alert on PHI Leakage
        if: steps.phi-scan.outputs.findings > 0
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "üö® CRITICAL: PHI Leakage Detected in Logs",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CRITICAL: Potential PHI Leakage Detected*\n‚Ä¢ Services with findings: ${{ steps.phi-scan.outputs.findings }}\n‚Ä¢ Immediate action required\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}

  iam-quarterly-review:
    name: Quarterly IAM Access Review
    runs-on: ubuntu-latest
    # Only run on quarterly schedule or manual trigger
    if: ${{ github.event.schedule == '0 8 1-7 1,4,7,10 1' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_AUDIT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Run IAM Access Review
        run: |
          pwsh ./scripts/audit/iam-access-review.ps1 -Region ${{ env.AWS_REGION }} -OutputFile iam-review.json

      - name: Upload IAM Review Report
        uses: actions/upload-artifact@v4
        with:
          name: iam-quarterly-review
          path: iam-review.json
          retention-days: 2555 # 7 years for HIPAA

      - name: Create Review Ticket
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[HIPAA] Quarterly IAM Access Review - ${today}`,
              body: `## Quarterly IAM Access Review\n\n**Date:** ${today}\n**Compliance:** HIPAA ¬ß164.308(a)(4)\n\n### Action Required\n\n1. Download the IAM review report from this workflow run\n2. Review all findings and recommendations\n3. Document remediation actions taken\n4. Sign off on the review\n\n### Artifacts\n\n- [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n### Attestation\n\n- [ ] Security Lead reviewed\n- [ ] Compliance Officer approved\n- [ ] Remediation complete`,
              labels: ['compliance', 'hipaa', 'security', 'quarterly-review']
            });

  rls-verification:
    name: Database RLS Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_AUDIT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Database Credentials
        run: |
          SECRET=$(aws secretsmanager get-secret-value --secret-id advancia/prod/aurora-phi --query SecretString --output text)
          echo "DATABASE_URL=$(echo $SECRET | jq -r '.connectionString')" >> $GITHUB_ENV

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Verify RLS Policies
        run: |
          psql "$DATABASE_URL" -c "
            SELECT
              schemaname,
              tablename,
              CASE WHEN rowsecurity THEN '‚úÖ' ELSE '‚ùå' END as rls_enabled,
              CASE WHEN forcerowsecurity THEN '‚úÖ' ELSE '‚ùå' END as force_rls
            FROM pg_tables
            JOIN pg_class ON pg_class.relname = pg_tables.tablename
            WHERE schemaname = 'health'
            ORDER BY tablename;
          "

      - name: Check for RLS Bypass
        run: |
          # Ensure no roles have BYPASSRLS
          BYPASS_ROLES=$(psql "$DATABASE_URL" -t -c "SELECT rolname FROM pg_roles WHERE rolbypassrls = true AND rolname NOT LIKE 'rds%';")
          if [ -n "$BYPASS_ROLES" ]; then
            echo "‚ö†Ô∏è Roles with BYPASSRLS: $BYPASS_ROLES"
            exit 1
          fi
          echo "‚úÖ No application roles have BYPASSRLS"

  compliance-summary:
    name: Generate Compliance Summary
    runs-on: ubuntu-latest
    needs: [infrastructure-audit, phi-redaction-audit, rls-verification]
    if: always()
    steps:
      - name: Download Audit Report
        uses: actions/download-artifact@v4
        with:
          name: compliance-audit-report
          path: ./reports
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "## Compliance Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Audit | ${{ needs.infrastructure-audit.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PHI Redaction | ${{ needs.phi-redaction-audit.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RLS Verification | ${{ needs.rls-verification.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Compliance Score:** ${{ needs.infrastructure-audit.outputs.compliance_score }}%" >> $GITHUB_STEP_SUMMARY
